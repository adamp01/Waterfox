name: Test

on:
    push:
        paths:
          - 'browser/config/version_display.txt'
    pull_request:
    workflow_dispatch:

jobs:
    build-windows:
        name: ðŸªŸ Build for Windows
        runs-on: windows-latest
        strategy:
            fail-fast: false
        env:
            ENABLE_ARTIFACTS_MODE: "true"
            MOZCONFIG: "./.mozconfig"
            MOZ_NOSPAM: 1
            JSIGN_PATH: /c/mozilla-build/bin/jsign-4.0.jar
            JAVA_PATH: /c/PROGRA~2/COMMON~1/Oracle/Java/javapath/java.exe
            TEST: ${{ secrets.TEST }}

        steps:
          - name: Checkout branch
            uses: actions/checkout@v2

          - name: Get Mozilla-Build
            shell: bash
            run: |
              curl -O https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe

          - name: Install Mozilla-Build
            run: |
              Start-Process -Wait -FilePath "MozillaBuildSetup-Latest.exe" -ArgumentList '/S','/v','/qn' -passthru

          - name: Mach build
            run: |
              $pattern = '[\\]'
              $env:BUILD_DIR = $env:GITHUB_WORKSPACE
              $env:BUILD_DIR = $env:BUILD_DIR -replace $pattern, '/'
              Write-Output $env:BUILD_DIR
              c:\\mozilla-build\\start-shell.bat "$env:BUILD_DIR/build/github-actions/test.sh"
